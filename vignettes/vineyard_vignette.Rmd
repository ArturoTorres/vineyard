---
title: "Bud break and phenology models for grapevine cultivars"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Bud break and phenology models for grapevine cultivars}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Setup
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(vineyard)
library(knitr)
library(xts)
library(spacetime)

timing.ini <- Sys.time()
```

## Load dataset
```{r load_dataset}
data(data_remich)
str(data_remich)
```

## Splitting data by years
```{r split_years}
# cohercing to data.frame
data.remich <- as.data.frame(data_remich)

# creating xts
data.remich <- xts(x = data.remich, order.by = data.remich$time)

years <- factor(data.remich$Year)
remich.years <- split(data.remich, years)
```

## Calculation of cumulative degree days (CDD) by the single triangle algorithm (Nelder, 2010) for bud break
```{r degree_days}
head(remich.years[[1]])

cdd <- cdd.single.triangle(data = remich.years, t.zero = 0, t.min.col = 16, t.mean.col = 17, t.max.col = 15)
head(cdd[[1]])

cdd.bb <- cdd.single.triangle.budbreak(cdd = cdd, start.date = 59)
head(cdd.bb[[1]])
```


## Calculation of degree-days by the single (lower) temperature threshold (Molitor et al., 2014)
```{r degree_days_molitor1}
cdd.lt <- cdd.lThresh(data = remich.years, t.mean.col = 17, a = 0)

head(cdd.lt[[1]])
```


## Calculation of phenology by the single temperature threshold (Molitor et al., 2014)
```{r phenology_molitor1}
# mean cumulative heat sum for bud break of 438.7 degree celsius for
# Mueller-Thurgau (Nelder, 2010)
cdd.phen.mthurgau <- cdd.lThresh.phenology(cdd.lt = cdd.lt, chs.mean = 438.7)
head(cdd.phen.mthurgau[[1]])

# mean cumulative heat sum for bud break of 438.7 degree celsius for
# Riesling (Nelder, 2010)
cdd.phen.riesling <- cdd.lThresh.phenology(cdd.lt = cdd.lt, chs.mean = 463.1)
head(cdd.phen.riesling[[1]])

# growth stages
data(GrowthStage_CDD)

GrowthStage_CDD

phen.mthurgau <- phenology.stages(cdd.phen = cdd.phen.mthurgau, ref.data = GrowthStage_CDD[-1,],
                                          stage = GrowthStage_CDD[-1,1])
phen.mthurgau[[1]]


phen.riesling <- phenology.stages(cdd.phen = cdd.phen.mthurgau, ref.data = GrowthStage_CDD[-1,],
                                      stage = GrowthStage_CDD[-1,1])
phen.riesling[[1]]

```

## Calculation of degree-days by the double (lower and upper) temperature thresholds (Molitor et al., 2014)
```{r degree_days_molitor2}
cdd.lut <- cdd.luThresh(data = remich.years, t.mean.col = 17, a = 0, b = 15)

head(cdd.lut[[1]])
```

## Calculation of phenology by the double (lower and upper) temperature thresholds (Molitor et al., 2014)
```{r phenology_molitor2}
# mean cumulative heat sum for bud break of 438.7 degree celsius for
# Mueller-Thurgau (Nelder, 2010)
cdd.phen.mthurgau.lut <- cdd.luThresh.phenology(cdd.lut = cdd.lut, chs.mean = 438.7)
head(cdd.phen.mthurgau.lut[[1]])

# mean cumulative heat sum for bud break of 438.7 degree celsius for
# Riesling (Nelder, 2010)
cdd.phen.riesling.lut <- cdd.luThresh.phenology(cdd.lut = cdd.lut, chs.mean = 463.1)
head(cdd.phen.riesling.lut[[1]])

# growth stages
phen.mthurgau.lut <- phenology.stages(cdd.phen = cdd.phen.mthurgau.lut, ref.data = GrowthStage_CDD[-1,],
                                  stage = GrowthStage_CDD[-1,1])
phen.mthurgau.lut[[1]]


phen.riesling.lut <- phenology.stages(cdd.phen = cdd.phen.mthurgau.lut, ref.data = GrowthStage_CDD[-1,],
                                  stage = GrowthStage_CDD[-1,1])
phen.riesling.lut[[1]]
```

## Calculation of degree-days by a lower, upper and heat temperature thresholds (Molitor et al., 2014)
```{r degree_days_molitor3}
cdd.luht <- cdd.luhThresh(data = remich.years, t.mean.col = 17, a = 5, b = 20, c = 22)

head(cdd.luht[[46]])
```

## Calculation of phenology by the lower, upper and heat temperature thresholds (Molitor et al., 2014)
```{r phenology_molitor3}

# mean cumulative heat sum for bud break of 438.7 degree celsius for
# Mueller-Thurgau (Nelder, 2010)
cdd.phen.mthurgau.luht <- cdd.luhThresh.phenology(cdd.bb = cdd.bb, cdd.luht = cdd.luht, chs.mean = 438.7)
head(cdd.phen.mthurgau.luht[[46]])

# mean cumulative heat sum for bud break of 463.1 degree celsius for
# Riesling (Nelder, 2010)
cdd.phen.riesling.luht <- cdd.luhThresh.phenology(cdd.bb = cdd.bb, cdd.luht = cdd.luht, chs.mean = 463.1)
head(cdd.phen.riesling.luht[[46]])

# growth stages
phen.mthurgau.luht <- phenology.stages(cdd.phen = cdd.phen.mthurgau.luht, ref.data = GrowthStage_CDD,
                                      stage = GrowthStage_CDD[-1,1])
phen.mthurgau.luht[[46]]


phen.riesling.luht <- phenology.stages(cdd.phen = cdd.phen.riesling.luht, ref.data = GrowthStage_CDD,
                                      stage = GrowthStage_CDD[-1,1])
phen.riesling.luht[[46]]
```

## Timing
```{r timing}
timing.end <- Sys.time()
(timing.elapsed <- timing.end - timing.ini)
```

## Session information
```{r session}
sessionInfo()
```
